{
  "description": "build my-app releases",
  "min_packer_version": "0.8.6",
  "variables": {
    "base_image": "centos:7",
    "source": "{{env `PWD`}}",
    "service_unit": "config/my-app.service",
    "artifact": "my-app-latest.tar.gz"
  },
  "builders": [
    {
      "type": "docker",
      "image": "{{user `base_image`}}",
      "discard": true
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "script": "scripts/prepare-release.sh"
    },
    {
      "type": "file",
      "source": "scripts",
      "destination": "/build"
    },
    {
      "type": "file",
      "source": "{{user `source`}}/",
      "destination": "/build/srv/app/current"
    },
    {
      "type": "file",
      "source": "{{user `service_unit`}}",
      "destination": "/build/etc/systemd/system/app.service"
    },
    {
      "type": "shell",
      "inline": [
        "chroot /build /scripts/install-dependencies.sh",
        "chroot /build /scripts/build-release.sh",
        "chroot /build yum -y clean all"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "rm -rf /build/scripts",
        "cd /build && tar -czf /build.tar.gz ."
      ]
    },
    {
      "type": "file",
      "source": "/build.tar.gz",
      "destination": "build.tar.gz",
      "direction": "download"
    }
  ],
  "post-processors": [
    {
      "type": "artifice",
      "files": ["{{user `artifact`}}"]
    }
  ]
}
